# Changelog - Rate Limit Protection для RAGAS Evaluation

## Дата: 2025-11-20

### Основные изменения

#### 1. Защита от Rate Limit ошибок (429) для RAGAS Evaluation

**Проблема**: При использовании Fireworks API для RAGAS evaluation возникали ошибки `429 Too Many Requests`, которые прерывали процесс оценки.

**Решение**: Реализована комплексная система защиты от rate limit:

- **RateLimitedLLM обертка**: Создан класс-обертка для LLM, который автоматически добавляет задержку между запросами (по умолчанию 2 секунды)
- **Увеличены параметры retry**: 
  - `RAGAS_MAX_RETRIES`: с 3 до 20 попыток
  - `RAGAS_MAX_WAIT`: с 180 до 1800 секунд (30 минут)
  - `RAGAS_REQUEST_TIMEOUT`: с 60 до 120 секунд
- **Новый параметр**: `RAGAS_REQUEST_DELAY` - задержка между запросами (по умолчанию 2.0 секунды)

#### 2. Исправления и улучшения

- **Исправлена ошибка с полем `llm`**: Решена проблема доступа к полю `llm` в `RateLimitedLLM` при использовании с `LangchainLLMWrapper`
- **Исправлена ошибка с `default_request_timeout`**: Удален неподдерживаемый параметр из `ChatOpenAI`
- **Исправлена ошибка с `HUGGINGFACE_DEVICE`**: Добавлена очистка значений от комментариев в `.env` файле
- **Уменьшено количество воркеров**: `max_workers` снижен с 4 до 1 для более стабильной работы

#### 3. Конфигурация

**Новые переменные окружения** (добавлены в `env.example`):
```env
RAGAS_MAX_RETRIES=20          # Количество повторных попыток
RAGAS_MAX_WAIT=1800           # Максимальное время ожидания (30 минут)
RAGAS_REQUEST_TIMEOUT=120.0   # Таймаут запроса (2 минуты)
RAGAS_REQUEST_DELAY=2.0       # Задержка между запросами (2 секунды)
```

#### 4. Технические детали

**Файлы изменены**:
- `src/evaluation.py`: Добавлен класс `RateLimitedLLM`, обновлена логика создания RAGAS LLM
- `src/config.py`: Добавлены новые параметры конфигурации для rate limit protection
- `env.example`: Обновлены примеры конфигурации

**Архитектура решения**:
1. `RateLimitedLLM` оборачивает базовый `ChatOpenAI` и добавляет задержку между запросами
2. Все методы (`invoke`, `ainvoke`, `_generate`, `_agenerate`) переопределены для применения rate limiting
3. При инициализации RAGAS метрик базовый LLM извлекается для `LangchainLLMWrapper`, затем заменяется обратно на `RateLimitedLLM` для работы rate limiting

### Результаты

- ✅ Устранены ошибки 429 (Rate Limit) при RAGAS evaluation
- ✅ Evaluation теперь работает стабильно с Fireworks API
- ✅ Настраиваемые параметры для различных API провайдеров
- ✅ Поддержка как внешних API (Fireworks), так и локальных моделей (HuggingFace)

### Рекомендации

Если все еще возникают ошибки 429, увеличьте `RAGAS_REQUEST_DELAY` в `.env`:
```env
RAGAS_REQUEST_DELAY=5.0  # или больше, например 10.0
```

