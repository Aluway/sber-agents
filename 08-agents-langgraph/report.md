# Отчет: Реализация инструмента конвертера валют для ReAct агента

## 1. Реализованный инструмент

### `currency_converter` - Конвертер валют

**Описание:**
Инструмент для конвертации сумм из одной валюты в другую с использованием актуальных курсов через API exchangerate-api.com.

**Технические детали:**
- **API:** exchangerate-api.com (v4 без ключа или v6 с API ключом)
- **Параметры:**
  - `amount: float` - сумма для конвертации
  - `from_currency: str` - исходная валюта (USD, EUR, RUB, GBP, JPY и др.)
  - `to_currency: str` - целевая валюта
- **Возвращает:** Строку с результатом конвертации и курсом обмена

**Особенности реализации:**
- Автоматическая нормализация кодов валют (верхний регистр)
- Обработка ошибок (таймауты, сетевые ошибки, неверные валюты)
- Поддержка работы без API ключа (бесплатный endpoint)
- Детальное логирование операций

**Пример использования:**
```
Пользователь: "Сколько будет 100 долларов в рублях?"
Агент: вызывает currency_converter(100.0, "USD", "RUB")
Результат: "100.00 USD = 9500.00 RUB (курс: 1 USD = 95.0000 RUB)"
```

---

## 2. Как агент принимает решения о вызове инструментов

### Архитектура принятия решений

Агент использует **ReAct паттерн** (Reasoning + Acting), реализованный через `create_agent()` из LangChain 1.0:

```
1. Reasoning (Рассуждение)
   ↓
2. Acting (Действие) - вызов инструмента или ответ
   ↓
3. Observation (Наблюдение) - получение результата
   ↓
4. Повтор цикла при необходимости
```

### Механизм принятия решений

**1. Системный промпт (`prompts/agent_system.txt`)**
- Содержит инструкции о том, когда использовать каждый инструмент
- Определяет правила поведения агента
- Указывает примеры использования инструментов

**2. LLM как "мозг" агента**
- Модель (`ChatOpenAI`) анализирует вопрос пользователя
- На основе системного промпта и контекста диалога решает:
  - Нужен ли вызов инструмента?
  - Какой инструмент использовать?
  - Какие параметры передать?
  - Достаточно ли информации для ответа?

**3. Доступные инструменты:**
- `rag_search(query: str)` - поиск в документах Сбербанка
- `currency_converter(amount, from_currency, to_currency)` - конвертация валют

**4. Процесс принятия решения:**

```python
# Агент получает вопрос
HumanMessage: "Сколько будет 100 долларов в рублях?"

# LLM анализирует и решает:
# - Это вопрос о конвертации валют
# - Нужен инструмент currency_converter
# - Параметры: amount=100, from_currency="USD", to_currency="RUB"

AIMessage с tool_calls: {
    "name": "currency_converter",
    "args": {"amount": 100.0, "from_currency": "USD", "to_currency": "RUB"}
}

# Инструмент выполняется
ToolMessage: "100.00 USD = 9500.00 RUB (курс: 1 USD = 95.0000 RUB)"

# Агент формирует финальный ответ
AIMessage: "100 долларов США составляет 9500 рублей по текущему курсу."
```

**5. Многошаговые рассуждения:**
Агент может вызывать инструменты несколько раз:
- Первый вызов `rag_search` не дал нужной информации → второй вызов с уточненным запросом
- Комбинация инструментов: сначала `rag_search` для поиска информации, затем `currency_converter` для расчетов

**6. Контекст диалога:**
- `MemorySaver` сохраняет историю диалога по `chat_id`
- Агент учитывает предыдущие сообщения при принятии решений
- Может отвечать без инструментов, если информация уже есть в контексте

---

## 3. Отличия от простой RAG-цепочки

### Простая RAG-цепочка

```
Вопрос → Поиск в векторах → Контекст → LLM → Ответ
```

**Характеристики:**
- ❌ Всегда выполняет поиск, даже если не нужен
- ❌ Один запрос = один поиск
- ❌ Нет возможности использовать внешние API
- ❌ Нет многошаговых рассуждений
- ❌ Жесткая последовательность: поиск → ответ

### ReAct агент

```
Вопрос → LLM анализирует → Решение: нужен инструмент?
    ├─ Да → Вызов инструмента → Анализ результата → Ответ
    └─ Нет → Прямой ответ на основе контекста
```

**Характеристики:**
- ✅ **Самостоятельное принятие решений** - агент сам решает, нужен ли поиск
- ✅ **Многошаговые рассуждения** - может вызывать инструменты несколько раз
- ✅ **Гибкость** - может отвечать без поиска (приветствия, уточнения)
- ✅ **Расширяемость** - легко добавлять новые инструменты (currency_converter, калькулятор и т.д.)
- ✅ **Контекстное понимание** - учитывает историю диалога
- ✅ **Комбинирование инструментов** - может использовать несколько инструментов в одном ответе

### Конкретные примеры различий

**Пример 1: Приветствие**
- **RAG-цепочка:** Выполнит поиск в документах (бесполезно)
- **Агент:** Поймет, что это приветствие, ответит без инструментов

**Пример 2: Конвертация валют**
- **RAG-цепочка:** Попытается найти информацию в документах (не найдет актуальные курсы)
- **Агент:** Вызовет `currency_converter` для получения актуальных курсов

**Пример 3: Сложный вопрос**
- **RAG-цепочка:** Один поиск, может не найти нужную информацию
- **Агент:** Может выполнить несколько поисков с разными запросами, комбинировать результаты

**Пример 4: Уточняющий вопрос в диалоге**
- **RAG-цепочка:** Выполнит новый поиск, даже если ответ уже был дан
- **Агент:** Использует контекст предыдущих сообщений, может ответить без поиска

---

## 4. Преимущества и ограничения

### Преимущества ReAct агента

#### 1. Интеллектуальное принятие решений
- ✅ Агент сам определяет, когда нужен поиск, а когда можно ответить напрямую
- ✅ Экономия ресурсов (меньше ненужных запросов к векторной БД)
- ✅ Более быстрые ответы на простые вопросы

#### 2. Гибкость и расширяемость
- ✅ Легко добавлять новые инструменты (currency_converter, калькулятор, погода и т.д.)
- ✅ Агент автоматически учится использовать новые инструменты через их описания
- ✅ Модульная архитектура - каждый инструмент независим

#### 3. Многошаговые рассуждения
- ✅ Может вызывать инструменты несколько раз с разными параметрами
- ✅ Может комбинировать результаты нескольких инструментов
- ✅ Способен к итеративному уточнению запросов

#### 4. Контекстное понимание
- ✅ Учитывает историю диалога через MemorySaver
- ✅ Может отвечать на уточняющие вопросы без нового поиска
- ✅ Поддерживает многошаговые диалоги

#### 5. Естественность взаимодействия
- ✅ Может отвечать на приветствия, благодарности без поиска
- ✅ Более естественное поведение, похожее на человека
- ✅ Лучший пользовательский опыт

### Ограничения и вызовы

#### 1. Сложность отладки
- ⚠️ Сложнее понять, почему агент принял то или иное решение
- ⚠️ Нужно логировать каждый шаг для диагностики
- ⚠️ Может быть непредсказуемым в edge cases

#### 2. Зависимость от качества LLM
- ⚠️ Качество решений напрямую зависит от модели
- ⚠️ Может принимать неверные решения (вызывать инструмент когда не нужно, или наоборот)
- ⚠️ Требует тщательной настройки системного промпта

#### 3. Производительность
- ⚠️ Может быть медленнее простой RAG-цепочки (дополнительные вызовы LLM для принятия решений)
- ⚠️ Многошаговые рассуждения увеличивают время ответа
- ⚠️ Больше токенов используется (системный промпт + описания инструментов)

#### 4. Стоимость
- ⚠️ Больше вызовов LLM = выше стоимость
- ⚠️ Каждый шаг рассуждения - отдельный запрос к API
- ⚠️ Нужна более мощная модель для качественных решений

#### 5. Необходимость настройки
- ⚠️ Требует тщательной настройки системного промпта
- ⚠️ Нужно четко описать, когда использовать каждый инструмент
- ⚠️ Может потребоваться fine-tuning для специфических задач

#### 6. Обработка ошибок
- ⚠️ Нужна надежная обработка ошибок в инструментах
- ⚠️ Агент должен правильно реагировать на ошибки инструментов
- ⚠️ Может зациклиться при неправильной обработке ошибок

### Рекомендации по использованию

**Когда использовать ReAct агента:**
- ✅ Нужна гибкость в принятии решений
- ✅ Требуется несколько типов инструментов (RAG + API + калькулятор)
- ✅ Важна естественность взаимодействия
- ✅ Нужны многошаговые рассуждения

**Когда использовать простую RAG-цепочку:**
- ✅ Простые задачи с одним источником информации
- ✅ Критична скорость ответа
- ✅ Ограниченный бюджет на API вызовы
- ✅ Нужна предсказуемость и простота отладки

---

## Заключение

Реализация инструмента `currency_converter` демонстрирует ключевые преимущества ReAct агента:
- **Расширяемость** - легко добавить новый инструмент
- **Интеллектуальность** - агент сам решает, когда использовать инструмент
- **Гибкость** - может комбинировать разные источники информации

ReAct агент представляет собой эволюцию простой RAG-цепочки, добавляя слой интеллектуального принятия решений. Это делает систему более гибкой и естественной, но требует больше ресурсов и настройки.

Для банковского ассистента это особенно ценно, так как позволяет:
- Отвечать на вопросы о документах (RAG)
- Выполнять расчеты и конвертации (currency_converter)
- Поддерживать естественный диалог без лишних поисков

